@page "/"
@using BlogFodder.Core.Data
@using BlogFodder.Core.Extensions
@using BlogFodder.Core.Plugins
@using BlogFodder.Core.Posts.Models
@using BlogFodder.Core.Settings
@using BlogFodder.Core.Shared.Models
@using Microsoft.EntityFrameworkCore
@using Microsoft.Extensions.Options

<PageTitle>@Settings.Value.FrontEnd.DefaultPageTitle</PageTitle>
<HeadContent>
    <meta name="description" content="@Settings.Value.FrontEnd.DefaultMetaDescription">
</HeadContent>

@ExtensionManager.CreateComponent(PostListComponent, new Dictionary<string, object>
{
    {"Posts", Posts}
})

@code
{
    [Inject]
    public BlogFodderDbContext DbContext { get; set; } = default!;

    [Inject]
    public NavigationManager NavigationManager { get; set; } = default!;
    
    [Inject]
    public ExtensionManager ExtensionManager { get; set; } = default!;
    
    [Inject]
    IOptionsSnapshot<BlogFodderSettings> Settings { get; set; } = default!;

    public PaginatedList<Post> Posts { get; set; } = new();

    private string PostListComponent { get; set; } = ""; 

    protected override void OnInitialized()
    {
        Posts = DbContext.Posts
            .AsQueryable()
            .Include(x => x.FeaturedImage)
            .Include(x => x.Categories)
            .AsNoTracking()
            .OrderByDescending(x => x.DateUpdated)
            .ToPaginatedList(0,18);
    }

    protected override void OnParametersSet()
    {
        PostListComponent = Settings.Value.FrontEnd.PostListComponent!;
    }
}