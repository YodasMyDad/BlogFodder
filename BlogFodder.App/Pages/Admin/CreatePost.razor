@page "/admin/createpost"
@page "/admin/createpost/{Id:guid}"
@using BlogFodder.Core.Posts.Models
@layout AdminLayout
<PageTitle>Create Post</PageTitle>

<MudForm Model="@Post" @ref="@Form" Validation="@(PostValidator.ValidateValue)" ValidationDelay="0">
    <MudTextField Label="Title of this post" Class="my-2"
                  Counter="1000" MaxLength="1000"
                  @bind-Value="Post.Name" For="@(() => Post.Name)" Variant="Variant.Outlined">
    </MudTextField>
    
    <MudTabs Outlined="true" Position="Position.Top" Rounded="true" Border="true" KeepPanelsAlive="true" ApplyEffectsToContainer="true" PanelClass="pa-6">

        <MudTabPanel Text="Excerpt">
            <MudGrid>
                <MudItem xs="12">
                    <MudTextField Lines="5" Label="Preview Text" Variant="Variant.Outlined" Margin="Margin.Dense"
                                  HelperText="Max. 3000 characters" @bind-Value="Post.Excerpt" For="@(() => Post.Excerpt)"/>
                </MudItem>
                <MudItem xs="12">
                    <MudField Label="Featured Image">
                        <BlogFodder.Plugins.Components.Form.FileUpload @bind-Value="FeaturedImage" ImagesOnly="true" MaxAllowedFiles="1" />
                    </MudField>
                </MudItem>
            </MudGrid>

        </MudTabPanel>

        <MudTabPanel Text="Content">

            <MudGrid Row="true">
                <MudItem>
                    <MudSelect Style="width: 400px" T="string" Variant="Variant.Outlined" Margin="Margin.Dense"
                               ValueChanged="SelectedEditorChanged"
                               Label="Choose your content type" AnchorOrigin="Origin.BottomCenter">
                        @foreach (var editor in AvailableEditorPlugins)
                        {
                            <MudSelectItem Value="@editor.Key">@editor.Value.Name</MudSelectItem>
                        }
                    </MudSelect>
                </MudItem>
                <MudItem>
                    <MudFab OnClick="AddNewContentItem" Color="Color.Primary" Size="Size.Medium" StartIcon="@Icons.Material.Filled.Add" Label="Add"/>
                </MudItem>
            </MudGrid>

            <MudDropContainer T="PostContentItem" @ref="_dropContainer" Items="Post.ContentItems" ItemsSelector="@((item, dropzone) => item.Selector == dropzone)" ItemDropped="DropItemUpdated" Class="d-flex flex-wrap flex-grow-1">
                <ChildContent>
                    <MudGrid Class="mt-8">
                        <MudDropZone T="PostContentItem" Identifier="plugins" AllowReorder="true" Class="flex-grow-1"/>
                    </MudGrid>
                </ChildContent>
                <ItemRenderer>
                    <MudItem xs="12" Class="mb-8">
                        <MudCard @onclick="() => ShowEditor(context)" Elevation="2" Class="rounded-lg pb-4">
                            <MudCardContent>
                                <DynamicComponent Type="@AvailableEditorPlugins[context.PluginAlias!].Editor?.PreviewComponent"
                                                  Parameters="@(new Dictionary<string, object> {{"PostContentItem", context}})"/>
                            </MudCardContent>
                        </MudCard>
                    </MudItem>
                </ItemRenderer>
            </MudDropContainer>
        </MudTabPanel>

        <MudTabPanel Text="SEO">

            <MudGrid>
                <MudItem xs="12">
                    <MudTextField Label="Page Title" HelperText="Max. 60 characters" Variant="Variant.Outlined" Margin="Margin.Dense"
                                  @bind-Value="Post.PageTitle" For="@(() => Post.PageTitle)"/>
                </MudItem>
                <MudItem xs="12">
                    <MudTextField Lines="4" Label="Meta Description" HelperText="Max. 300 characters" Variant="Variant.Outlined" Margin="Margin.Dense"
                                  @bind-Value="Post.MetaDescription" For="@(() => Post.MetaDescription)"/>
                </MudItem>
                <MudItem xs="12">
                    <MudField Label="Social Image">
                        <BlogFodder.Plugins.Components.Form.FileUpload @bind-Value="SocialImage" ImagesOnly="true" MaxAllowedFiles="1" />
                    </MudField>
                </MudItem>
                <MudItem xs="12">
                    <MudSwitch @bind-Checked="@Post.NoIndex" Label="No Index" Color="Color.Info"/>
                </MudItem>
            </MudGrid>
        </MudTabPanel>

        <MudTabPanel Text="Settings">
            <MudGrid>
                <MudItem xs="12">
                    <MudTextField @bind-Value="Post.Url" Label="Url" Variant="Variant.Outlined" Margin="Margin.Dense"></MudTextField>
                </MudItem>
                <MudItem xs="12">
                    <MudDatePicker Label="Date Created" Variant="Variant.Outlined" Margin="Margin.Dense" PickerVariant="PickerVariant.Dialog" DisableToolbar="true" @bind-Date="DateCreated"/>
                </MudItem>
                <MudItem xs="12">
                    <MudDatePicker Label="Date Updated" Variant="Variant.Outlined" Margin="Margin.Dense" PickerVariant="PickerVariant.Dialog" DisableToolbar="true" @bind-Date="DateUpdated"/>
                </MudItem>
            </MudGrid>
        </MudTabPanel>

    </MudTabs>
    <MudItem xs="12" Class="d-flex justify-center">
        <MudButton Variant="Variant.Filled" OnClick="@(async () => await SubmitForm())" DisableElevation="true" Color="Color.Primary" Size="Size.Large" Class="mt-8">Save</MudButton>
    </MudItem>
</MudForm>