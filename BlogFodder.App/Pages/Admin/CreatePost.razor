@page "/admin/createpost"
@using BlogFodder.Core.Posts.Models
@layout AdminLayout
@inject IDialogService Dialog
<PageTitle>Create Post</PageTitle>

<EditForm Context="createPostContext" Model="Post" OnValidSubmit="SubmitForm">
    <FluentValidationValidator/>
    `
    <MudTextField Label="Title of this post" Class="my-2"
                  Counter="1000" MaxLength="1000"
                  DebounceInterval="500" OnDebounceIntervalElapsed="HandleIntervalElapsed"
                  @bind-Value="Post.Name" For="@(() => Post.Name)" Variant="Variant.Outlined">
    </MudTextField>

    <MudTabs Outlined="true" Position="Position.Top" Rounded="true" Border="true" ApplyEffectsToContainer="true" PanelClass="pa-6">

        <MudTabPanel Text="Excerpt">
            <MudTextField Lines="5" Label="Preview Text" HelperText="Max. 3000 characters"
                          @bind-Value="Post.Excerpt" For="@(() => Post.Excerpt)"/>

            <MudField Label="Featured Image">
                <MudFileUpload T="IBrowserFile" FilesChanged="SetFeaturedImage">
                    <ButtonTemplate>
                        <MudButton HtmlTag="label"
                                   Variant="Variant.Filled"
                                   Color="Color.Primary"
                                   StartIcon="@Icons.Material.Filled.CloudUpload"
                                   for="@context">
                            Choose Image
                        </MudButton>
                    </ButtonTemplate>
                </MudFileUpload>
            </MudField>
        </MudTabPanel>

        <MudTabPanel Text="Content">
            <MudStack Row="true">
                <MudItem xs="8">
                    <MudText>
                        Choose a content item to add
                    </MudText>
                </MudItem>
                <MudItem xs="4">
                    <MudStack Row="true">
                        <MudSelect T="string"
                                   ValueChanged="OnContentItemChanged"
                                   Label="Editors" AnchorOrigin="Origin.BottomCenter">
                            @foreach (var editor in AvailableEditorPlugins)
                            {
                                <MudSelectItem Value="@editor.Key">@editor.Value.Name</MudSelectItem>
                            }
                        </MudSelect>
                        <MudButton OnClick="AddNewContentItem">Add</MudButton>
                    </MudStack>
                </MudItem>
            </MudStack>

            <MudDropContainer T="PostContentItem" @ref="_container" Items="Post.ContentItems" ItemsSelector="@((item, dropzone) => item.Selector == dropzone)" ItemDropped="ItemUpdated" Class="d-flex flex-wrap flex-grow-1">
                <ChildContent>
                    <MudGrid Class="mt-8">
                        <MudDropZone T="PostContentItem" Identifier="plugins" AllowReorder="true" Class="flex-grow-1"/>
                    </MudGrid>
                </ChildContent>
                <ItemRenderer>
                    <MudItem xs="12" Class="mb-8">
                        <MudCard @onclick="() => ShowEditor(context)" Elevation="3" Class="rounded-lg pb-4">
                            <MudCardContent>
                                @*<MudText Typo="Typo.h5" Align="Align.Center">@context.PluginAlias</MudText>
                                   <MudText Typo="Typo.h5" Align="Align.Center">@context.PluginData</MudText>*@
                                <DynamicComponent Type="@AvailableEditorPlugins[context.PluginAlias].Editor.PreviewComponent"
                                                      Parameters="@(new Dictionary<string, object> {{"PostContentItem", context}})"/>
                            </MudCardContent>
                        </MudCard>
                    </MudItem>
                </ItemRenderer>
            </MudDropContainer>

        </MudTabPanel>

        <MudTabPanel Text="SEO">
            <MudText>SEO</MudText>
            <MudTextField Label="Page Title" HelperText="Max. 60 characters"
                          @bind-Value="Post.PageTitle" For="@(() => Post.PageTitle)"/>
            <MudTextField Lines="5" Label="Meta Description" HelperText="Max. 300 characters"
                          @bind-Value="Post.MetaDescription" For="@(() => Post.MetaDescription)"/>
            <MudField Label="Social Image">
                <MudFileUpload T="IBrowserFile" FilesChanged="SetSocialImage">
                    <ButtonTemplate>
                        <MudButton HtmlTag="label"
                                   Variant="Variant.Filled"
                                   Color="Color.Primary"
                                   StartIcon="@Icons.Material.Filled.CloudUpload"
                                   for="@context">
                            Choose Image
                        </MudButton>
                    </ButtonTemplate>
                </MudFileUpload>
            </MudField>
            <MudSwitch @bind-Checked="@Post.NoIndex" Label="No Index" Color="Color.Info"/>
        </MudTabPanel>

        <MudTabPanel Text="Settings">
            <MudText>Settings</MudText>
            <MudTextField @bind-Value="Post.Url" Label="Url" Variant="Variant.Text"></MudTextField>
            <MudDatePicker Label="Date Created" PickerVariant="PickerVariant.Dialog" DisableToolbar="true" @bind-Date="DateCreated"/>
            <MudDatePicker Label="Date Updated" PickerVariant="PickerVariant.Dialog" DisableToolbar="true" @bind-Date="DateUpdated"/>
        </MudTabPanel>

    </MudTabs>
</EditForm>