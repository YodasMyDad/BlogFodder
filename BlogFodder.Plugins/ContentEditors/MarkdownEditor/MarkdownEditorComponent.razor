@using BlogFodder.Core.Extensions
@using BlogFodder.Core.Posts.Models
@implements BlogFodder.Core.Plugins.Interfaces.IEditorPluginComponent
@inject IJSRuntime JsRuntime

<MudDialog>
    <DialogContent>
        <MudTabs Rounded="true" ApplyEffectsToContainer="true" PanelClass="py-6 ">

            <MudTabPanel Text="Editor">
                <MudCard>
                    <textarea id="@EditorId">@PostContentItem.PluginData</textarea>
                </MudCard>
            </MudTabPanel>

            @*<MudTabPanel Text="Settings">
                <MudTextField @bind-Value="Post.Url" Label="Url" Variant="Variant.Text"></MudTextField>
                    <MudDatePicker Label="Date Created" PickerVariant="PickerVariant.Dialog" DisableToolbar="true" @bind-Date="DateCreated"/>
                    <MudDatePicker Label="Date Updated" PickerVariant="PickerVariant.Dialog" DisableToolbar="true" @bind-Date="DateUpdated"/>
            </MudTabPanel>*@

        </MudTabs>
    </DialogContent>
    <DialogActions>
        <MudButton Color="Color.Primary" OnClick="Submit">Ok</MudButton>
    </DialogActions>
</MudDialog>

@code {

    //https://www.puresourcecode.com/dotnet/blazor/markdown-editor-component-for-blazor/

    [Parameter]
    public PostContentItem PostContentItem { get; set; } = new();

    [Parameter]
    public EventCallback<PostContentItem> SaveAndClose { get; set; }
    
    private string EditorId { get; set; } = string.Empty;

    public async Task<Task> Submit()
    {
        PostContentItem.PluginData = await GetEditorValue();
        //PostContentItem.PluginSettings = JsonSerializer.Serialize(EditorSettings, new JsonSerializerOptions{ WriteIndented = false});
        return SaveAndClose.InvokeAsync(PostContentItem);
    }
    
    protected override async Task OnInitializedAsync()
    {
        EditorId = $"easymde-{PostContentItem.Id}";
        
        if (!PostContentItem.PluginData.IsNullOrWhiteSpace())
        {
            await SetEditorValue(PostContentItem.PluginData);
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JsRuntime.InvokeVoidAsync("initializeEasyMDE", EditorId);
        }
    }
    
    private async Task<string> GetEditorValue()
    {
        return await JsRuntime.InvokeAsync<string>("getEasyMDEValue", EditorId);
    }

    private async Task SetEditorValue(string data)
    {
        await JsRuntime.InvokeVoidAsync("setEasyMDEValue", EditorId, data);
    }

}